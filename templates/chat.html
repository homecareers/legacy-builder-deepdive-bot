<!DOCTYPE html>
<html>
<head>
  <title>ANGUS™ — Legacy Builder Deep Dive</title>
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #050608;
      color: #f5f5f5;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .chat-box {
      max-width: 780px;
      margin: 30px auto;
      background: #0f0f0f;
      padding: 30px;
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.85);
      border: 1px solid #222;
    }
    .message {
      margin: 14px 0;
      line-height: 1.6;
      animation: fadeIn 0.45s ease-in;
    }
    .bot { color: #f5f5f5; }
    .user {
      color: #D4A72C;
      text-align: right;
      font-weight: 600;
    }
    .step-label {
      font-size: 14px;
      font-weight: 600;
      color: #D4A72C;
      margin-bottom: 4px;
    }
    .bot strong { color: #D4A72C; }
    .options {
      margin-top: 10px;
    }
    .options button {
      display: block;
      width: 100%;
      padding: 10px 14px;
      margin: 6px 0;
      border-radius: 10px;
      border: 1px solid #D4A72C;
      background: #111;
      color: #f5f5f5;
      text-align: left;
      cursor: pointer;
      font-size: 15px;
      transition: all 0.2s ease;
    }
    .options button:hover {
      background: #D4A72C;
      color: #050608;
      transform: translateY(-2px);
      box-shadow: 0 0 18px rgba(212,167,44,0.45);
    }
    .options button.selected {
      background: #D4A72C;
      color: #050608;
      box-shadow: 0 0 18px rgba(212,167,44,0.45);
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 10px;
      background: #111;
      border: 2px solid #333;
      color: #f5f5f5;
      font-size: 15px;
      box-sizing: border-box;
      font-family: 'Inter', Arial, sans-serif;
    }
    textarea { min-height: 90px; resize: vertical; }
    input:focus, textarea:focus {
      outline: none;
      border-color: #D4A72C;
      box-shadow: 0 0 10px rgba(212,167,44,0.35);
    }
    .next-btn, .submit-btn {
      background: #D4A72C;
      color: #050608;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      margin-top: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .next-btn:hover, .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 18px rgba(212,167,44,0.45);
    }
    .loading {
      color: #D4A72C;
      font-style: italic;
    }
    .loading::after {
      content: "...";
      animation: dots 1.5s infinite;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes dots {
      0%   { content: ""; }
      33%  { content: "."; }
      66%  { content: ".."; }
      100% { content: "..."; }
    }
  </style>
</head>

<body>
  <div class="chat-box" id="chat"></div>

  <script>
    const chat = document.getElementById('chat');
    const BACKEND_URL = "/submit";

    // ---------------- DEEP DIVE QUESTION SET ---------------- //

    const steps = [
      { type: "single", question: "Q7 — When you picture your ideal business life 2–3 years from now, what feels most important?", options: [
        "Time freedom with stable income",
        "Scaling meaningful impact",
        "Building a team + community",
        "Replacing or exceeding my current income",
        "Proving to myself I can actually do it"
      ]},
      { type: "single", question: "Q8 — Right now, where do you mostly show up online?", options: [
        "Facebook",
        "Instagram",
        "TikTok",
        "YouTube",
        "Other / I barely show up"
      ]},
      { type: "single", question: "Q9 — How would you describe your current consistency with posting or creating content?", options: [
        "I rarely post",
        "I post sometimes but not consistently",
        "I'm consistent but not business-focused yet",
        "I'm consistent and intentional with content"
      ]},
      { type: "single", question: "Q10 — When it comes to talking about products or opportunities online…", options: [
        "I’m confident and comfortable",
        "I’m willing but nervous",
        "I mostly avoid it right now",
        "Haven’t really tried yet"
      ]},
      { type: "single", question: "Q11 — How do you feel about learning new tech/tools?", options: [
        "Love it — I pick it up fast",
        "I can learn it with clear steps",
        "I get overwhelmed easily",
        "I'd rather keep it super simple"
      ]},
      { type: "single", question: "Q12 — How do you prefer to be coached?", options: [
        "Direct and straightforward",
        "Encouraging and supportive",
        "Step-by-step with examples",
        "Give me the target and let me run"
      ]},
      { type: "single", question: "Q13 — In a perfect world, how many hours per week would you eventually like to be investing into your business?", options: [
        "5–10 hours",
        "10–15 hours",
        "15–20 hours",
        "20+ hours"
      ]},
      { type: "single", question: "Q14 — What best describes your current financial starting point?", options: [
        "I’m comfortable but want more options",
        "I’m tight and need relief fast",
        "I’m rebuilding from a setback",
        "I’m stable and focused on growth"
      ]},
      { type: "single", question: "Q15 — What feels MOST natural when it comes to connecting with people?", options: [
        "One-on-one conversations",
        "Small group settings",
        "Online messages / DM chats",
        "Creating content that people respond to"
      ]},
      { type: "single", question: "Q16 — Which statement feels most true about your confidence level?", options: [
        "I’m confident — I just need a system",
        "I’m confident in some areas, shaky in others",
        "My confidence is rebuilding",
        "I’m not confident yet, but I’m willing"
      ]},
      { type: "single", question: "Q17 — How do you respond when a plan doesn’t work the first time?", options: [
        "I regroup and try again",
        "I need someone to walk through it with me",
        "I tend to shut down and avoid it",
        "I overthink what went wrong"
      ]},
      { type: "multi", question: "Q18 — What kind of support will help you actually follow through? (Select all that apply.)", options: [
        "Clear weekly targets",
        "Accountability check-ins",
        "Community / team energy",
        "Simple scripts and language",
        "Visual trackers or dashboards"
      ]},
      { type: "single", question: "Q19 — When you think about earning with this, what feels most aligned?", options: [
        "A solid side income",
        "Replacing my current income",
        "Building a serious long-term business",
        "I’m still feeling this out"
      ]},
      { type: "single", question: "Q20 — If we built you a simple daily method of operation (DMO), what’s realistic for you right now?", options: [
        "20–30 minutes per day",
        "30–60 minutes per day",
        "60–90 minutes per day",
        "More than 90 minutes per day"
      ]},
      { type: "single", question: "Q21 — Which GEM style do you FEEL you resonate with most?", options: [
        "Pearl — heart, connection, service",
        "Ruby — recognition, fun, energy",
        "Sapphire — structure, systems, clarity",
        "Emerald — goals, numbers, wealth-building",
        "Not sure yet"
      ]},
      { type: "multi", question: "Q22 — What usually pulls you OFF track when you set big goals? (Select all that apply.)", options: [
        "Life chaos and distractions",
        "No clear plan or structure",
        "Lack of encouragement or community",
        "Fear of judgment or failure",
        "Time management / overwhelm"
      ]},
      { type: "multi", question: "Q23 — How do you prefer to track progress? (Select all that apply.)", options: [
        "Daily check marks",
        "Income movement",
        "Emotional / energy check-ins",
        "Visual charts / dashboards",
        "Stories of people I’ve helped"
      ]},
      { type: "text", question: "Q24 — Why is NOW the right time for you to build something instead of waiting another year?", placeholder: "Type what’s really true for you here..." },
      { type: "text", question: "Q25 — What are the top 1–2 fears or hesitations you want your coach to know before you start?", placeholder: "Be honest. This helps us coach you better." },
      { type: "text", question: "Q26 — What strengths do you bring to the table that we can build on together?", placeholder: "Skills, experience, personality, anything that makes you an asset." },
      { type: "text", question: "Q27 — What does a WIN in the next 90 days look like for you?", placeholder: "Describe it in your own words." },
      { type: "text", question: "Q28 — Is there anything from your past business or work experience that we should *not* repeat this time?", placeholder: "Patterns, approaches, or situations you’re done with." },
      { type: "text", question: "Q29 — How do you want your coach to show up for you when you’re struggling?", placeholder: "Direct tough love, gentle encouragement, structured action steps, etc." },
      { type: "text", question: "Q30 — Anything else you want us to know about your vision, life season, or expectations?", placeholder: "Optional, but powerful if you share it." },

      // Step 25 - Email
      { type: "email", question: "And finally… what’s the BEST email for your custom 90-day Legacy Builder projection?" }
    ];

    const TOTAL_STEPS = steps.length; // 25
    let currentStep = -1;
    let answers = [];
    let userEmail = "";

    // ---------------- MESSAGE FUNCTIONS ---------------- //

    function showBotMessage(msg) {
      chat.innerHTML += `<div class="message bot">${msg}</div>`;
      chat.scrollTop = chat.scrollHeight;
    }

    function showUserMessage(msg) {
      chat.innerHTML += `<div class="message user">${msg}</div>`;
      chat.scrollTop = chat.scrollHeight;
    }

    function showLoading() {
      chat.innerHTML += `<div class="message loading" id="loading">ANGUS is thinking</div>`;
      chat.scrollTop = chat.scrollHeight;
    }

    function hideLoading() {
      const l = document.getElementById("loading");
      if (l) l.remove();
    }

    // ---------------- RENDER STEPS ---------------- //

    function renderStep() {
      currentStep++;

      if (currentStep >= TOTAL_STEPS) return;

      const step = steps[currentStep];

      showLoading();
      setTimeout(() => {
        hideLoading();

        const label = `<div class="step-label">Step ${currentStep + 1} of ${TOTAL_STEPS}</div>`;
        showBotMessage(label + step.question);

        if (step.type === "single" || step.type === "multi") {
          let html = `<div class="options">`;
          step.options.forEach((opt, idx) => {
            const safe = opt.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            html += `<button onclick="handleOption('${step.type}', '${safe}', this)">${opt}</button>`;
          });
          html += `</div>`;
          chat.innerHTML += html;

          if (step.type === "multi") {
            chat.innerHTML += `<button class="next-btn" onclick="finalizeMulti('${currentStep}')">Next</button>`;
          }
        }

        if (step.type === "text") {
          chat.innerHTML += `
            <div id="text-block-${currentStep}">
              <textarea id="text-input-${currentStep}" placeholder="${step.placeholder}"></textarea>
              <button class="next-btn" onclick="saveText('${currentStep}')">Next</button>
            </div>
          `;
        }

        if (step.type === "email") {
          chat.innerHTML += `
            <div id="email-block">
              <input id="email-input" type="email" placeholder="Enter your email...">
              <button class="submit-btn" onclick="saveEmail()">Submit</button>
            </div>
          `;
        }

        chat.scrollTop = chat.scrollHeight;

      }, 700);
    }

    // ---------------- ANSWER CAPTURE ---------------- //

    function handleOption(type, value, btn) {
      if (type === "single") {
        const container = btn.parentElement;
        [...container.querySelectorAll("button")].forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        showUserMessage(value);
        answers.push(value);
        container.remove();
        const nextBtn = chat.querySelector(".next-btn");
        if (nextBtn) nextBtn.remove();
        setTimeout(renderStep, 300);
      } else {
        btn.classList.toggle("selected");
      }
    }

    function finalizeMulti(stepIndex) {
      const container = chat.querySelector(".options:last-of-type");
      const selected = [...container.querySelectorAll("button.selected")].map(btn => btn.textContent.trim());

      if (selected.length === 0) {
        showBotMessage("Select at least one option before moving on.");
        return;
      }
      showUserMessage(selected.join(", "));
      answers.push(selected.join(", "));
      container.remove();
      chat.querySelector(".next-btn").remove();
      setTimeout(renderStep, 300);
    }

    function saveText(stepIndex) {
      const val = document.getElementById(`text-input-${stepIndex}`).value.trim();
      if (!val) {
        showBotMessage("Go ahead — type your answer. It doesn’t have to be perfect.");
        return;
      }
      showUserMessage(val);
      answers.push(val);
      document.getElementById(`text-block-${stepIndex}`).remove();
      setTimeout(renderStep, 300);
    }

    function saveEmail() {
      const email = document.getElementById("email-input").value.trim();
      if (!email) {
        showBotMessage("I’ll need your email so your coach can prep your custom 90-day projection.");
        return;
      }
      userEmail = email;
      showUserMessage(email);
      document.getElementById("email-block").remove();
      submitSurvey();
    }

    // ---------------- SUBMIT SURVEY (THE CRITICAL FIX) ---------------- //

    function submitSurvey() {
      showLoading();

      if (!Array.isArray(answers)) answers = [];

      fetch(BACKEND_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: userEmail,
          answers: answers
        })
      })
      .then(res => res.json())
      .then(data => {
        hideLoading();
        if (data.redirect_url) {
          window.top.location.href = data.redirect_url;
        } else {
          showBotMessage("Something glitched. Refresh and try again.");
        }
      })
      .catch(err => {
        console.error(err);
        hideLoading();
        showBotMessage("Server issue. Refresh and try again.");
      });
    }

    // ---------------- INIT ---------------- //

    window.onload = () => {
      showBotMessage("Alright legend — I’m ANGUS™. This Deep Dive locks in the intel your coach will use to build your 90-day Legacy Builder projection with precision.");
      setTimeout(renderStep, 1400);
    };

    window.handleOption = handleOption;
    window.finalizeMulti = finalizeMulti;
    window.saveText = saveText;
    window.saveEmail = saveEmail;

  </script>
</body>
</html>
