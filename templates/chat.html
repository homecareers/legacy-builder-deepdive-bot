<!DOCTYPE html>
<html>
<head>
  <title>ANGUSâ„¢ â€” Legacy Builder Deep Dive</title>
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: #050608;
      color: #f5f5f5;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    .chat-box {
      max-width: 780px;
      margin: 30px auto;
      background: #0f0f0f;
      padding: 30px;
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.85);
      border: 1px solid #222;
    }
    .message {
      margin: 14px 0;
      line-height: 1.6;
      animation: fadeIn 0.45s ease-in;
    }
    .bot { color: #f5f5f5; }
    .user {
      color: #D4A72C;
      text-align: right;
      font-weight: 600;
    }
    .step-label {
      font-size: 14px;
      font-weight: 600;
      color: #D4A72C;
      margin-bottom: 4px;
    }
    .bot strong { color: #D4A72C; }
    .options {
      margin-top: 10px;
    }
    .options button {
      display: block;
      width: 100%;
      padding: 10px 14px;
      margin: 6px 0;
      border-radius: 10px;
      border: 1px solid #D4A72C;
      background: #111;
      color: #f5f5f5;
      text-align: left;
      cursor: pointer;
      font-size: 15px;
      transition: all 0.2s ease;
    }
    .options button:hover {
      background: #D4A72C;
      color: #050608;
      transform: translateY(-2px);
      box-shadow: 0 0 18px rgba(212,167,44,0.45);
    }
    .options button.selected {
      background: #D4A72C;
      color: #050608;
      box-shadow: 0 0 18px rgba(212,167,44,0.45);
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      border-radius: 10px;
      background: #111;
      border: 2px solid #333;
      color: #f5f5f5;
      font-size: 15px;
      box-sizing: border-box;
      font-family: 'Inter', Arial, sans-serif;
    }
    textarea { min-height: 90px; resize: vertical; }
    input:focus, textarea:focus {
      outline: none;
      border-color: #D4A72C;
      box-shadow: 0 0 10px rgba(212,167,44,0.35);
    }
    .next-btn, .submit-btn {
      background: #D4A72C;
      color: #050608;
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      margin-top: 10px;
      cursor: pointer;
      font-size: 15px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .next-btn:hover, .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 18px rgba(212,167,44,0.45);
    }
    .loading {
      color: #D4A72C;
      font-style: italic;
    }
    .loading::after {
      content: "...";
      animation: dots 1.5s infinite;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    @keyframes dots {
      0%   { content: ""; }
      33%  { content: "."; }
      66%  { content: ".."; }
      100% { content: "..."; }
    }
    @media(max-width: 600px) {
      .chat-box { padding: 20px; margin: 10px auto; }
    }
  </style>
</head>
<body>
  <div class="chat-box" id="chat"></div>

  <script>
    const chat = document.getElementById('chat');
    const BACKEND_URL = "/submit";  // relative â†’ uses same domain/app

    // 24 answer steps (you can tweak question text without touching logic)
    const steps = [
      { type: "single", question: "Q7 â€” When you picture your ideal business life 2â€“3 years from now, what feels most important?", options: [
        "Time freedom with stable income",
        "Scaling meaningful impact",
        "Building a team + community",
        "Replacing or exceeding my current income",
        "Proving to myself I can actually do it"
      ]},
      { type: "single", question: "Q8 â€” Right now, where do you mostly show up online?", options: [
        "Facebook",
        "Instagram",
        "TikTok",
        "YouTube",
        "Other / I barely show up"
      ]},
      { type: "single", question: "Q9 â€” How would you describe your current consistency with posting or creating content?", options: [
        "I rarely post",
        "I post sometimes but not consistently",
        "I'm consistent but not business-focused yet",
        "I'm consistent and intentional with content"
      ]},
      { type: "single", question: "Q10 â€” When it comes to talking about products or opportunities onlineâ€¦", options: [
        "I'm confident and comfortable",
        "I'm willing but nervous",
        "I mostly avoid it right now",
        "Haven't really tried yet"
      ]},
      { type: "single", question: "Q11 â€” How do you feel about learning new tech/tools?", options: [
        "Love it â€” I pick it up fast",
        "I can learn it with clear steps",
        "I get overwhelmed easily",
        "I'd rather keep it super simple"
      ]},
      { type: "single", question: "Q12 â€” How do you prefer to be coached?", options: [
        "Direct and straightforward",
        "Encouraging and supportive",
        "Step-by-step with examples",
        "Give me the target and let me run"
      ]},
      { type: "single", question: "Q13 â€” In a perfect world, how many hours per week would you eventually like to be investing into your business?", options: [
        "5â€“10 hours",
        "10â€“15 hours",
        "15â€“20 hours",
        "20+ hours"
      ]},
      { type: "single", question: "Q14 â€” What best describes your current financial starting point?", options: [
        "I'm comfortable but want more options",
        "I'm tight and need relief fast",
        "I'm rebuilding from a setback",
        "I'm stable and focused on growth"
      ]},
      { type: "single", question: "Q15 â€” When you think about talking to people, what feels MOST natural?", options: [
        "One-on-one conversations",
        "Small group settings",
        "Online messages / DM chats",
        "Creating content that people respond to"
      ]},
      { type: "single", question: "Q16 â€” Which statement feels most true about your confidence level?", options: [
        "I'm confident â€” I just need a system",
        "I'm confident in some areas, shaky in others",
        "My confidence is rebuilding",
        "I'm not confident yet, but I'm willing"
      ]},
      { type: "single", question: "Q17 â€” How do you respond when a plan doesn't work the first time?", options: [
        "I regroup and try again",
        "I need someone to walk through it with me",
        "I tend to shut down and avoid it",
        "I overthink what went wrong"
      ]},
      { type: "multi", question: "Q18 â€” What kind of support will help you actually follow through? (Select all that apply.)", options: [
        "Clear weekly targets",
        "Accountability check-ins",
        "Community / team energy",
        "Simple scripts and language",
        "Visual trackers or dashboards"
      ]},
      { type: "single", question: "Q19 â€” When you think about earning with this, what feels most aligned?", options: [
        "A solid side income",
        "Replacing my current income",
        "Building a serious long-term business",
        "I'm still feeling this out"
      ]},
      { type: "single", question: "Q20 â€” If we built you a simple daily method of operation (DMO), what's realistic for you right now?", options: [
        "20â€“30 minutes per day",
        "30â€“60 minutes per day",
        "60â€“90 minutes per day",
        "More than 90 minutes per day"
      ]},
      { type: "single", question: "Q21 â€” Which GEM style do you FEEL you resonate with most?", options: [
        "Pearl â€” heart, connection, service",
        "Ruby â€” recognition, fun, energy",
        "Sapphire â€” structure, systems, clarity",
        "Emerald â€” goals, numbers, wealth-building",
        "Not sure yet"
      ]},
      { type: "multi", question: "Q22 â€” What usually pulls you OFF track when you set big goals? (Select all that apply.)", options: [
        "Life chaos and distractions",
        "No clear plan or structure",
        "Lack of encouragement or community",
        "Fear of judgment or failure",
        "Time management / overwhelm"
      ]},
      { type: "multi", question: "Q23 â€” How do you prefer to track progress? (Select all that apply.)", options: [
        "Daily check marks",
        "Income movement",
        "Emotional / energy check-ins",
        "Visual charts / dashboards",
        "Stories of people I've helped"
      ]},
      { type: "text", question: "Q24 â€” Why is NOW the right time for you to build something instead of waiting another year?", placeholder: "Type what's really true for you here..." },
      { type: "text", question: "Q25 â€” What are the top 1â€“2 fears or hesitations you want your coach to know before you start?", placeholder: "Be honest. This helps us coach you better." },
      { type: "text", question: "Q26 â€” What strengths do you bring to the table that we can build on together?", placeholder: "Skills, experience, personality, anything that makes you an asset." },
      { type: "text", question: "Q27 â€” What does a WIN in the next 90 days look like for you?", placeholder: "Describe it in your own words." },
      { type: "text", question: "Q28 â€” Is there anything from your past business or work experience that we should *not* repeat this time?", placeholder: "Patterns, approaches, or situations you're done with." },
      { type: "text", question: "Q29 â€” How do you want your coach to show up for you when you're struggling?", placeholder: "Direct tough love, gentle encouragement, structured action steps, etc." },
      { type: "text", question: "Q30 â€” Anything else you want us to know about your vision, life season, or expectations?", placeholder: "Optional, but powerful if you share it." },
      // Step 25 (non-answer): email capture
      { type: "email", question: "And finallyâ€¦ what's the best email for your custom Legacy Builder plan to land in? Use the same one you used to download your Real Brick Roadâ„¢ booklet." }
    ];

    const TOTAL_STEPS = steps.length; // 25 total (24 answers + email)

    let currentStep = -1;   // intro first
    let answers = [];       // 24 Deep Dive answers only
    let userEmail = "";

    function showBotMessage(html) {
      chat.innerHTML += `<div class="message bot">${html}</div>`;
      chat.scrollTop = chat.scrollHeight;
    }

    function showUserMessage(text) {
      chat.innerHTML += `<div class="message user">${text}</div>`;
      chat.scrollTop = chat.scrollHeight;
    }

    function showLoading() {
      chat.innerHTML += `<div class="message loading" id="loading">ANGUS is thinking</div>`;
      chat.scrollTop = chat.scrollHeight;
    }

    function hideLoading() {
      const el = document.getElementById('loading');
      if (el) el.remove();
    }

    function renderStep() {
      currentStep++;

      if (currentStep >= TOTAL_STEPS) {
        return;
      }

      const step = steps[currentStep];

      showLoading();
      setTimeout(() => {
        hideLoading();

        const stepLabel = `<div class="step-label">Step ${currentStep + 1} of ${TOTAL_STEPS}</div>`;
        showBotMessage(stepLabel + step.question);

        if (step.type === "single" || step.type === "multi") {
          let html = `<div class="options">`;
          step.options.forEach((opt, idx) => {
            // ----------------------
            // ðŸ”¥ FIX APPLIED HERE
            // Now escaping BOTH single quotes and double quotes
            // to prevent JavaScript onclick handler breaking
            // ----------------------
            const safe = opt.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            html += `<button type="button" data-index="${idx}" onclick="handleOptionClick(${currentStep}, '${step.type}', this, '${safe}')">${opt}</button>`;
          });
          html += `</div>`;
          chat.innerHTML += html;

          if (step.type === "multi") {
            chat.innerHTML += `<button class="next-btn" onclick="finalizeMulti(${currentStep})">Next</button>`;
          }

        } else if (step.type === "text") {
          chat.innerHTML += `
            <div id="text-block-${currentStep}">
              <textarea id="text-input-${currentStep}" placeholder="${step.placeholder || ''}"></textarea>
              <button class="next-btn" onclick="saveTextAnswer(${currentStep})">Next</button>
            </div>
          `;
        } else if (step.type === "email") {
          chat.innerHTML += `
            <div id="email-block">
              <input id="email-input" type="email" placeholder="Enter your email..." />
              <button class="submit-btn" onclick="saveEmail()">Submit</button>
            </div>
          `;
        }

        chat.scrollTop = chat.scrollHeight;

      }, 700);
    }

    // Handle single + multi-select clicks
    function handleOptionClick(stepIndex, type, btn, value) {
      if (type === "single") {
        const container = btn.parentElement;
        Array.from(container.querySelectorAll("button")).forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
        // record & advance immediately
        showUserMessage(value);
        answers.push(value);
        // remove options + buttons
        container.remove();
        const nextBtn = chat.querySelector(".next-btn");
        if (nextBtn) nextBtn.remove();
        setTimeout(renderStep, 300);
      } else {
        // multi-select toggle
        btn.classList.toggle("selected");
      }
    }

    // Called when Next clicked on multi-select step
    function finalizeMulti(stepIndex) {
      const step = steps[stepIndex];
      const container = chat.querySelector(".options:last-of-type");
      if (!container) {
        showBotMessage("Select at least one option.");
        return;
      }
      const selected = Array.from(container.querySelectorAll("button.selected")).map(b => b.textContent.trim());
      if (selected.length === 0) {
        showBotMessage("Select at least one option.");
        return;
      }
      const summary = selected.join(", ");
      showUserMessage(summary);
      answers.push(summary);
      container.remove();
      const nextBtn = chat.querySelector(".next-btn");
      if (nextBtn) nextBtn.remove();
      setTimeout(renderStep, 300);
    }

    // Text answer
    function saveTextAnswer(stepIndex) {
      const input = document.getElementById(`text-input-${stepIndex}`);
      if (!input) return;
      const val = input.value.trim();
      if (!val) {
        showBotMessage("Go ahead and type your answer â€” it doesn't have to be perfect.");
        return;
      }
      showUserMessage(val);
      answers.push(val);
      document.getElementById(`text-block-${stepIndex}`).remove();
      setTimeout(renderStep, 300);
    }

    // Email capture (not part of Deep Dive 24 answers)
    function saveEmail() {
      const input = document.getElementById("email-input");
      if (!input) return;
      const email = input.value.trim();
      if (!email) {
        showBotMessage("I'll need your email so your coach can prep your custom 90-day projection.");
        return;
      }
      userEmail = email;
      showUserMessage(email);
      document.getElementById("email-block").remove();
      submitSurvey();
    }

    function submitSurvey() {
      showLoading();
      // answers MUST be an array â€” extra guard
      if (!Array.isArray(answers)) {
        answers = [];
      }
      fetch(BACKEND_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          email: userEmail,
          answers: answers
        })
      })
      .then(res => res.json())
      .then(data => {
        hideLoading();
        if (data.redirect_url) {
          window.top.location.href = data.redirect_url;
        } else {
          showBotMessage("Something glitched. Refresh and try again.");
        }
      })
      .catch(err => {
        console.error(err);
        hideLoading();
        showBotMessage("Server issue. Refresh and try again.");
      });
    }

    // Expose functions globally
    window.handleOptionClick = handleOptionClick;
    window.finalizeMulti = finalizeMulti;
    window.saveTextAnswer = saveTextAnswer;
    window.saveEmail = saveEmail;

    // Intro + start
    window.onload = function() {
      showBotMessage("Alright legend â€” I'm ANGUSâ„¢. This Deep Dive locks in the intel your coach will use to build your Legacy Builder projection with precision. Answer honestly â€” this is for YOU.");
      setTimeout(renderStep, 1400);
    };
  </script>
</body>
</html>
